from sklearn.feature_extraction.text import TfidfVectorizer
from raw_analysis import raw_analysis
import sys
import pefile
import pydasm
import os
import numpy as np

class Opcode():

  def __init__(self):
    self.vectorizer = TfidfVectorizer(max_df = 0.75, max_features = 400000, min_df = 0.05, ngram_range=(5,5), use_idf=True, decode_error='ignore')
    self.max_number = sys.maxint

  def set_n_grams(self, value):
    self.n_grams = value

  def disassemble(self, pe_data, file_name):
    file = open(file_name, "w")
    try:
      ep = pe_data.OPTIONAL_HEADER.AddressOfEntryPoint
      ep_ava = ep+pe_data.OPTIONAL_HEADER.ImageBase
      data = pe_data.get_memory_mapped_image()[ep:ep + self.size_of_raw_data(pe_data)]
      offset = 0
      while offset < len(data):
        i = pydasm.get_instruction(data[offset:], pydasm.MODE_32)
        instruction = pydasm.get_instruction_string(i, pydasm.FORMAT_INTEL, ep_ava+offset)
        if instruction == None :
          break
        offset += i.length
        file.write(instruction.split(' ', 1)[0])
        file.write('\n')
    except Exception as e:
      print e

  def size_of_raw_data(self, pe_data):
    raw_analyzer = raw_analysis.Raw()
    return raw_analyzer.size_of_raw_data(pe_data)


  def extract_features(self, cluster, input_directory, output_directory):
    cluster.set_vectorizer(self.vectorizer)
    data_list = self.get_opcodes_from_data(input_directory)
    self.get_top_features(cluster, data_list, output_directory)

  def get_opcodes_from_data(self, input_directory):
    files = os.listdir(input_directory)
    opcodes_lists = []
    for file in files:
      file_name = input_directory + "/" + file
      file_opcodes = self.list_string(self.read_file(file_name))
      opcodes_lists.append(file_opcodes)
    return opcodes_lists

  def read_file(self,file_name):
    lines = [line.rstrip('\n') for line in open(file_name)]
    return lines

  def list_string(self, data_list):
    document = ','.join(data_list)
    return document

  def get_top_features(self, cluster, data_list, output_directory):
    cluster.set_data(data_list)
    cluster.extract_top_features(output_directory)