class FeaturesHandler():

  def __init__(self):
    self.rules_directory = None
    self.train_data_set_directory = None
    self.test_data_set_directory = None
    self.raw_analyzer = raw_analysis.Raw()
    self.dll_analyzer = dll_analysis.Dll()
    self.opcodes_analyzer = opcode_analysis.Opcode()
    self.extension = ".txt"
    self.raw_name = "raw"
    self.dll_name = "dll"
    self.opcodes_name = "opcode"
    self.feature_name = "feature" + self.extension
    self.features_directory = os.getcwd() + "/features"
    self.raw = False
    self.dll = False
    self.opcodes = False


  def set_rules_directory(self, value):
    self.rules_directory = value

  def set_train_data_set_directory(self, value):
    self.train_data_set_directory = value

  def set_test_data_set_directory(self, value):
    self.test_data_set_directory = value

  def analysis_names(self, raw, dll, opcodes):
    self.raw_name = raw
    self.dll_name = dll
    self.opcodes_name = opcodes

  def set_features_name(self, value):
    self.feature_name = value

  def set_features_directory(self, value):
    self.features_directory = value

  def active_analysis(self, raw, dll, opcodes):
    self.raw = raw
    self.dll = dll
    self.opcodes = opcodes

  def extract():
    cluster_settings = self.set_cluster_settings()
    self.get_top_features(cluster_settings)

  def get_top_features_through_rules(self):
    rules = self.get_rules()
    message = False
    self.create_directory(self.features_directory, message)
    for index, rule in enumerate(rules):
      self.create_directory(self.features_directory + "/rule_" + str(index), message)
      self.get_best_features(rule, index)

  def get_rules(self):
    lines = self.read_file(self.rules_directory)
    rules_labels = lines[0].split(",")
    rules = []
    lines.pop(0)
    for line in lines:
      rules_dicc = {}
      for index,value in enumerate(line.split(",")):
        label = rules_labels[index]
        rules_dicc[label] = value
      rules.append(rules_dicc)
    return rules 

  def get_best_features(self, rule_settings, rule_number):
    for folder in os.listdir(self.train_data_set_directory):
      raw_feature_directory, dll_feature_directory, opcode_feature_directory = self.set_directories(self.features_directory + "/rule_" + str(rule_number) + "/" + folder)
      try:
        if self.dll:
          dll_input_directory = self.train_data_set_directory + "/" + folder + "/" + self.dll_name
          dll_output_directory = dll_feature_directory + "/" + self.feature_name
          self.dll_analyzer.extract_features(dll_input_directory, dll_output_directory, rule_settings)
        if self.opcodes:
          opcode_input_directory = self.train_data_set_directory + "/" + folder + "/" + self.opcodes_name
          opcode_output_directory = opcode_feature_directory + "/" + self.feature_name
          self.opcodes_analyzer.extract_features(opcode_input_directory, opcode_output_directory, rule_settings)
      except Exception as e:
        print e

  def feature_vector(self, rule_index):
    raw_features, dll_features, opcodes_features = self.get_all_features(rule_index)
    raw_vector, dll_vector, opcode_vector = self.convert_lists_to_vector(raw_features, dll_features, opcodes_features)
    self.write_feature_vector(rule_index, raw_vector, dll_vector, opcode_vector)

  def get_all_features(self, rule_index):
    raw_features = []
    dll_features = []
    opcodes_features = []
    directory = self.features_directory + "/rule_" + str(rule_index)
    for folder in os.listdir(directory):
      if self.raw:
        True
        #raw_directory = self.features_directory + "/" + folder + "/" + self.raw_name + "/" + self.feature_name
      if self.dll:
        dll_directory = directory + "/" + folder + "/" + self.dll_name + "/" + self.feature_name
        dll_features = dll_features  + self.read_file(dll_directory)
      if self.opcodes:
        opcodes_directory = directory + "/" + folder + "/" + self.opcodes_name + "/" + self.feature_name
        opcodes_features = opcodes_features + self.read_file(opcodes_directory)
    return raw_features, dll_features, opcodes_features
       
  def convert_lists_to_vector(self, raw_data_list, dll_data_list, opcode_data_list):
    raw_features = []
    dll_features = []
    opcodes_features = []
    #Quitar el set para q permita q se repitan y verificar que no se joda
    if self.raw:
      True
    if self.dll:
      dll_features =list(set(dll_data_list))
    if self.opcodes:
      opcodes_features = list(set(opcode_data_list))
    return raw_features,dll_features,opcodes_features       

  def write_feature_vector(self, rule_index, raw_vector, dll_vector, opcode_vector):
    #raw_vector_file = 
    dll_vector_file = self.features_directory + "/rule_" + str(rule_index) + "/feature_vector_dll" + self.extension
    opcode_vector_file = self.features_directory + "/rule_" + str(rule_index) + "/feature_vector_opcode" + self.extension
    #self.write_file(raw_vector_file, raw_vector)
    self.write_file(dll_vector_file, dll_vector)
    self.write_file(opcode_vector_file, opcode_vector) 

  def vectorize(self, train):
    rules = self.get_rules()
    for index, rule in enumerate(rules):
      if train :
        self.vectorize_samples(index, self.feature, self.train_data_set_directory)
      else:
        #revisar el nombre de la ruta donde se guardara el test
        #crear la carpeta rule_index
        self.vectorize_samples(index, "test_features",self.test_data_set_directory)

  def vectorize_samples(self, rule_index, root_directory, directory):
    #REVISAR TODO
    matrix_file = root_directory + "/rule_" + str(rule_index) + "/matrix_features" + self.extension
    matrix_file = open(matrix_file, "w")
    for folder in os.listdir(directory):
      name_base = directory + "/" + folder + "/"
      #falta agregar el archivo index al train y al test
      index_file = name_base + self.index_files_name
      files_in_folder = self.read_file(index_file)
      #leer los vectores de caracteristica para la regla actual
      #dll_feature_vector = self.read_file(self.dll_feature_vector_name)
      #opcode_feature_vector = self.read_file(self.opcode_feature_vector_name)

      for file in files_in_folder:
        raw_vector = []
        dll_binary_vector = []
        opcodes_binary_vector = []
        if self.raw:
          return True
        if self.dll:
          dll_attributes = self.read_file(name_base + self.dll_name + "/" + file + self.extension)
          dll_binary_vector = self.get_binary_vector(dll_attributes, dll_feature_vector)
        if self.opcodes:
          opcodes_attributes = self.read_file(name_base + self.opcodes_name + "/" + file + self.extension)
          opcodes_binary_vector = self.get_binary_vector(self.opcodes_analyzer.ngrams(opcodes_attributes), opcode_feature_vector)
        sample_vector = raw_vector + dll_binary_vector + opcodes_binary_vector
        if self.valid_sample_vector(sample_vector):
          sample_vector = self.add_identifie_features(sample_vector, file, folder)
          for item in sample_vector:
            matrix_file.write(str(item))
            matrix_file.write(",")
          matrix_file.write("\n")
    matrix_file.close()    

  def get_binary_vector(self, attributes, vector):
    #1 the sample has the feature 
    #0 the sample has not the feature
    output_vector = []
    for feature in vector:
      output_vector = output_vector + [int(feature in attributes)]
    return output_vector

  def valid_sample_vector(self, vector):
    percentage_of_zeros = round(vector.count(0) / float(len(vector)), 2)
    return percentage_of_zeros < self.limit_good_sample    

  def read_file(self,file_name):
    lines = [line.rstrip('\n') for line in open(file_name)]
    return lines

  def write_file(self, output_file, data_list):
    file = open(output_file, "w")
    for item in data_list:
      file.write(item)
      file.write("\n")
    file.close()

  def set_directories(self, path):
    raw_directory = path + "/" + self.raw_name
    dll_directory = path + "/" + self.dll_name
    opcode_directory = path + "/" + self.opcodes_name
    message = False
    if self.raw:
      self.create_directory(raw_directory, message)
    if self.dll:
      self.create_directory(dll_directory, message)
    if self.opcodes:
      self.create_directory(opcode_directory, message)
    return raw_directory, dll_directory, opcode_directory    

  def create_directory(self, directory, message):
    if message:
      print "Samples are stored in " + directory
    if not os.path.exists(directory):
      os.makedirs(directory)    