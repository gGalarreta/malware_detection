import os
from scipy.sparse import *
import numpy as np

class Plotter():

  def __init__(self):
    self.extract_uniques_elements = True
    self.data_directory = None
    self.dll = True
    self.opcodes = True
    self.plotter_directory = os.getcwd() + "/" + "statistics"
    self.summarize_directory = self.plotter_directory + "/summary/"
    
  def set_data_directory(self, value):
    self.data_directory = value

  def set_extract_uniques_elements(self, value):
    self.extract_uniques_elements = value

  def set_dll(self, value):
    self.dll = value

  def set_opcodes(self, value):
    self.opcodes = value

  def set_summarize_directory(self, value):
    self.summarize_directory = value

  def summary(self):
    self.handling_data()
    self.summarize_data()

  def handling_data(self):
    if self.extract_uniques_elements:
      for folder in os.listdir(self.data_directory):
        dll_list = None
        opcodes_list = None
        current_data_directory = self.summarize_directory + folder
        self.create_directory(current_data_directory)
        index = self.read_file(self.data_directory + "/" + folder + "index.txt")
        for file in index:
          if self.dll :
            dll_list = self.handling_unique_elements(dll_list, self.data_directory + "/" + folder + "/dll/" + file + ".txt")
          if self.opcodes :
            opcodes_list = self.handling_unique_elements(opcodes_list, self.data_directory + "/" + folder + "/opcode/" + file + ".txt")
        self.create_directory(current_path + "/dll")
        self.create_directory(current_path + "/opcode")
        if self.dll:
          write_file(current_path + "/dll/feature.txt", dll_list)
        if self.opcodes:
          write_file(current_path + "/opcode/feature.txt", opcodes_list)

  def handling_unique_elements(self, current_list, path):
    data_list = self.read_file(path)
    data_list = list(set(data_list))
    data_list = list(set(current_list + data_list))
    return data_list

  def summarize_data(self):
    dll_file = open(self.summarize_directory + "/dll_summary.txt", "w")
    opcode_file = open(self.summarize_directory + "/opcode_summary.txt", "w")
    for folder in os.listdir(self.summarize_directory):
      dll_unique_list = None
      opcode_unique_list = None
      if self.dll:
        dll_unique_list = self.read_file(self.summarize_directory + "/" + folder + "/dll/feature.txt")
        element_frequencies = self.assess_and_plot_data(folder, dll_unique_list, dll_file)
      if self.opcode :
        opcode_unique_list = self.read_file(self.summarize_directory + "/" + folder + "/opcode/feature.txt")
        element_frequencies = self.assess_and_plot_data(folder, opcode_unique_list, opcode_file)
    dll_file.close()
    opcode_file.close()

  def assess_and_plot_data(self, folder, unique_list, output_file):
    path = self.data_directory + "/" + folder
    index = self.read_file( path + "/index.txt")
    assess_data = {el:0 for el in unique_list}
    for file in index:
      term = self.term
      data_path = path + "/" + term + "/" + file + ".txt"
      data = read_file(data_path)
      for val in data:
        assess_data[val] +=1
    #imprimir en el archivo las cabeceras y las salidas por familia



  def term(self):
    if self.dll
      return "dll"
    if self.opcode:
      return "opcode"

  def read_file(self,file_name):
    lines = [line.rstrip('\n') for line in open(file_name)]
    return lines

  def create_directory(self, directory):
    if not os.path.exists(directory):
      os.makedirs(directory)

  def write_file(self, output_file, data_list):
    file = open(output_file, "w")
    for item in data_list:
      file.write(item)
      file.write("\n")
    file.close()      