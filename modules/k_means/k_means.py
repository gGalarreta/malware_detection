from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.cluster import KMeans
from sklearn.metrics import silhouette_samples, silhouette_score
import numpy as np

class Kmeans():

  def __init__(self):
    self.tfidf_vectorizer = None
    self.number_top_words = 20
    self.cluster_range = range(2,3)
    self.scores = []
    self.top_words = {}
    self.top_words_optimal_k = []
    self.tfidf_matrix = None
    self.terms = None

  def set_number_top_words(self, value):
    self.number_top_words = value

  def set_vectorizer(self, vectorizer):
    self.tfidf_vectorizer = vectorizer

  def set_cluster_range(self, lower_limit, upper_limit):
    self.cluster_range = range(lower_limit, upper_limit)
    
  def set_data(self, documents):
    self.tfidf_matrix = self.tfidf_vectorizer.fit_transform(documents)
    self.terms = self.tfidf_vectorizer.get_feature_names()

  def extract_top_features(self, output_file):
    self.find_optimal_cluster_number()
    self.select_top_features()
    self.write_file(output_file, self.top_words_optimal_k)

  def find_optimal_cluster_number(self):
    try:
      for k in self.cluster_range:
        km = KMeans(n_clusters = k)
        km.fit(self.tfidf_matrix)
        clusters = km.labels_
        order_centroids = km.cluster_centers_.argsort()[:,::-1]
        cluster_top_words = []
        for i in range(k):
          top_words = [str(self.terms[term_index]) for term_index in order_centroids[i, :self.number_top_words]]
          cluster_top_words = cluster_top_words + top_words
        self.top_words[k] = cluster_top_words
        self.scores = self.scores + [silhouette_score(self.tfidf_matrix, clusters)]
    except Exception as e:
      print e

  def select_top_features(self):
    max_score = max(self.scores)
    index_max_score = self.scores.index(max_score) + self.cluster_range[0]
    self.top_words_optimal_k = np.unique(self.top_words[index_max_score])

  def write_file(self, output_file, data_list):
    file = open(output_file, "w")
    for item in data_list:
      file.write(item)
      file.write("\n")
    file.close()






